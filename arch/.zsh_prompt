# ~/.dotfiles/arch/.zshrc

# Requires: wireless_tools

# Left Prompt
function liveroot {
  check=`cat /proc/cmdline | grep oroot=`
  if [ $? -eq 0 ]; then
    echo 1 # TRUE
  else
    echo 0
  fi
}

function liveroot_p {
  if [ $(liveroot) -eq 1 ]; then
    echo '[%F{red}LIVE%F{reset}] '
  fi
}

PROMPT='$(liveroot_p)[zsh] %n@%M %~%b%b $ '

# Right Prompt
function last_exit_status {
  last_exit=$?
  if [ $last_exit -eq 0 ]; then
    echo "%F{green}:)%F{reset}"
  else
    echo "%F{red}:(%F{reset} ($last_exit)"
  fi
}

function datetime_p {
  date "+%H:%M %d %h"
}

function current_ssid_p {
 SSID=`iwgetid -r 2> /dev/null`
  if [ $? -eq 0 ]; then
    echo "{%F{magenta}$SSID%F{reset}} "
  fi
}

function battery_percent {
  local bat_charge_full=`cat /sys/class/power_supply/BAT0/charge_full`
  local bat_charge_now=`cat /sys/class/power_supply/BAT0/charge_now`
  echo `awk -v full=$bat_charge_full -v now=$bat_charge_now 'BEGIN { printf "%d", now / full * 100 }'`
}

function battery_gauge_p {
  local bat_status=`cat /sys/class/power_supply/BAT0/status`

  if [ $bat_status = "Full" ]; then
    echo "[%F{green}full%F{reset}]"
  elif [ $bat_status = "Charging" ]; then
    local bat_percent=$(battery_percent)

    if [ $bat_percent -ge 30 ]; then
      echo "[%F{green}$bat_percent%F{reset}]"
    else
      echo "[%F{red}$bat_percent%F{reset}]"
     fi
  elif [ $bat_status = "Discharging" ]; then
    local bat_percent=$(battery_percent)

    if [ $bat_percent -ge 75 ]; then
      echo "[%F{green}----%F{reset}]"
    elif [ $bat_percent -ge 50 ]; then
      echo "[%F{green}---%F{reset}]"
    elif [ $bat_percent -ge 30 ]; then
      echo "[%F{green}--%F{reset}]"
    elif [ $bat_percent -ge 20 ]; then
      echo "[%F{red}--%F{reset}]"
    else
      echo "[%F{red}%B$bat_percent%b%F{reset}]"
    fi
  else
    echo "[?]"
  fi
}

function battery_remaining {
  local bat_status=`cat /sys/class/power_supply/BAT0/status`

  if [[ $bat_status = "Charging" || $bat_status = "Discharging" ]]; then
    bat_charge_now=`cat /sys/class/power_supply/BAT0/charge_now`
    bat_current_avg=`cat /sys/class/power_supply/BAT0/current_avg`
    echo `awk -v now=$bat_charge_now -v avg=$bat_current_avg 'BEGIN { printf "%0.1fh ", now / avg }'`
  fi
}

if [ ! -z "$DISPLAY" ]; then # hide in desktop environment
  RPROMPT=""
# elif [ `uname -r | grep "^4"` ]; then # show for linux >=4
  # RPROMPT='$(last_exit_status) $(current_ssid_p)[ $(datetime_p) $(battery_gauge_p) $(battery_remaining)]'
else
  RPROMPT='$(last_exit_status) $(current_ssid_p)[ $(datetime_p)]'
fi
